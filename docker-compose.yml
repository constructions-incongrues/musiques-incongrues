name: flarum

services:
  db:
    image: mariadb:10.11.13
    command:
      - mysqld
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - db_data:/var/lib/mysql
    restart: always
    env_file: .env

  flarum:
    image: crazymax/flarum:1.8.10
    depends_on:
      - db
    volumes:
      - ./src/flarum/composer.json:/opt/flarum/composer.json
      - ./src/flarum/composer.lock:/opt/flarum/composer.lock
      - ./var/flarum/data:/data
      - ./var/flarum/vendor:/opt/flarum/vendor
    environment:
      - DB_HOST=db
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
    restart: always
    env_file: .env
    networks:
      - caddy
      - default
    labels:
      caddy: futur.musiques-incongrues.net
      caddy.reverse_proxy: "{{upstreams 8000}}"

  phpmyadmin:
    image: phpmyadmin
    restart: always
    env_file: .env
    labels:
      caddy: pma.musiques-incongrues.net
      caddy.reverse_proxy: "{{upstreams 80}}"
    ports:
      - 8010:80
    networks:
      - caddy
      - default

  n8n:
    image: docker.n8n.io/n8nio/n8n:1.105.4
    restart: always
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://n8n:5678/
      - GENERIC_TIMEZONE=Europe/Paris
      - N8N_DEFAULT_LOCALE=fr-FR
      - N8N_RUNNERS_ENABLED=true
    volumes:
      - n8n_data:/home/node/.n8n
      - ./etc/workflows.json:/tmp/workflows.json
    env_file: .env
    labels:
      caddy: n8n.musiques-incongrues.net
      caddy.reverse_proxy: "{{upstreams 5678}}"
    networks:
      - caddy
      - default

  s9formatter:
    build:
      context: ./opt/s9formatter-api
      dockerfile: Dockerfile
    env_file: .env
    command: php -S 0.0.0:8020 -t /var/www/html

  smtp:
    image: registry.gitlab.com/egos-tech/smtp:latest
    environment:
      - SMARTHOST_ADDRESS=smtp.gmail.com
      - SMARTHOST_PORT=587
      - GMAIL_USER=${GMAIL_USER}
      - GMAIL_PASSWORD=${GMAIL_PASSWORD}

networks:
  caddy:
    external: true

volumes:
  db_data: ~
  flarum_data: ~
  n8n_data: ~